<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <title>Pedigree Questionnaire</title>
</head>
<body>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script type="text/javascript">
  // <![CDATA[
  var editorWindow = null;
  var editorPage = "localEditor.html";
  var windowName = "open-pedigree";
  var sendWhenReady = false;
  var localStorageKey = 'pedigreeData';
  var qDataStorageKey = 'questionnaireData';
  var formCounts = {
    conditions: 6,
    partner: 4,
    child: 15,
    sibling: 15,
    m_sibling: 15,
    f_sibling: 15,
    m_extended: 15,
    f_extended: 15,
  };

  window.addEventListener('storage', function(storageEvent){
    if (storageEvent.storageArea == window.localStorage && storageEvent.key == localStorageKey) {
      // the data has been updated
      console.log("Got storage event, updating fields");
      var data = JSON.parse(storageEvent.newValue);
      $("#context").val(data.context);
      $("#data").val(data.value);
      var FHIRdata = JSON.parse(data.value);
      if (FHIRdata){
        if (FHIRdata.contained){
          for (let containedResource of FHIRdata.contained){
            console.log(containedResource)
            if (containedResource.id === 'pedigreeImage'){
              let svg = decodeURIComponent(escape(atob(containedResource.content.attachment.data)));
              var container = document.getElementById("SVGContainer");
              container.innerHTML = svg;
              break;
            }
          }
        }
      }
    }
    if (storageEvent.storageArea == window.localStorage && storageEvent.key == qDataStorageKey) {
      // the data has been updated
      console.log("Got storage event, updating questionnaire data");
      var data = JSON.parse(storageEvent.newValue);
      updateQuestionnaireData(data);
    }
  }, false);

  function openEditor(element){
    console.log("Opening panogram editor in a new window");

    var firstChar = '?';
    var pageToOpen = editorPage;
    var ontologyServer = $("#ontologyServer").val();
    if (ontologyServer) {
      pageToOpen += firstChar + 'ontologyServer=' + ontologyServer;
      firstChar = '&';
    }
    if($('#sctMode').is(':checked')){
      pageToOpen += firstChar + 'mode=SCT';
      firstChar = '&';
    }
    var context = $("#context").val();
    var data = $("#data").val().trim();

    var pedigreeData = {'value': data, 'context': context};

    let qData = buildQuestionnaireData();

    if (qData && qData.length > 0){
      pageToOpen += firstChar + 'qData=' + qDataStorageKey;
      firstChar = '&';
      localStorage.setItem(qDataStorageKey, JSON.stringify(qData, null, 2));
    }

    localStorage.setItem(localStorageKey, JSON.stringify(pedigreeData, null, 2));

    editorWindow = window.open(pageToOpen, windowName);
  }

  function clearData(element){
    console.log("Clearing");
    $("#context").val("");
    $("#data").val("");
    $("#SVGContainer").empty();
  }

  function generateError(element){
    console.log("Generating Error");
    let qData = buildQuestionnaireData();

    if (qData && qData.length > 0){
      $("#errmessage").val('Please copy and paste this into a mail\n'
      + JSON.stringify(qData, null, 2));
    }
  }


  function getAttributeValue(elementId){
    let element = $(elementId);
    if (element.length){
      const val = element.val();
      if (element.is('input') && element.attr('type') === 'checkbox'){
        if (element.prop('checked')){
          return val;
        }
        return undefined;
      }
      if ($.type(val) === "string" && val.trim().length === 0){
        return undefined;
      }
      return val;
    }
    return undefined;
  }

  function buildPersonData(tag, attributes) {

    const arrayAttributes = ['problem', 'problem_age'];
    const booleanAttributes = ['deceased'];

    let personData = { tag: tag };

    let first = true;
    for (const attributeDef of attributes){
      if ($.type(attributeDef) === "string"){
        const attributeName = attributeDef;
        const elementId = '#' + tag + '_' + attributeName;
        const attributeValue = getAttributeValue(elementId);
        if (first){
          if ($.type(attributeValue) === "undefined"){
            return undefined;
          }
          first = false;
        }
        if ($.type(attributeValue) !== "undefined"){
          if (arrayAttributes.includes(attributeName)){
            if (attributeName in personData){
              personData[attributeName].push(attributeValue);
            }
            else {
              personData[attributeName] = [attributeValue];
            }
          } else if (booleanAttributes.includes(attributeName)){
            console.log('deceased attribute value = ', attributeValue);
            personData[attributeName] = true;
          }
          else {
            personData[attributeName] = attributeValue;
          }
        }
      }
      else {
        if ('attribute' in attributeDef){
          const attributeName = attributeDef.attribute;
          for (let i = 1; i <= attributeDef.count; i++){
            const elementId = '#' + tag + '_' + attributeDef.mask.replace('%', i.toString());
            const attributeValue = getAttributeValue(elementId);
            if ($.type(attributeValue) !== "undefined") {
              if (attributeName in personData) {
                personData[attributeName].push(attributeValue);
              }
              else if (booleanAttributes.includes(attributeName)){
                personData[attributeName] = true;
              }
              else {
                personData[attributeName] = [attributeValue];
              }
            }
          }
        }
        else if ('attributes' in attributeDef){
          for (let i = 1; i <= attributeDef.count; i++){

            for (let attributeNo = 0; attributeNo < attributeDef.attributes.length; attributeNo++){
              let attributeName = attributeDef.attributes[attributeNo];
              const elementId = '#' + tag + '_' + attributeDef.masks[attributeNo].replace('%', i.toString());
              let attributeValue = getAttributeValue(elementId);
              if ($.type(attributeValue) !== "undefined") {
                if (attributeName in personData) {
                  personData[attributeName].push(attributeValue);
                }
                else if (booleanAttributes.includes(attributeName)){
                  personData[attributeName] = true;
                }
                else {
                  personData[attributeName] = [attributeValue];
                }
              } else {
                if (attributeNo === 0){
                  // empty first
                  break;
                }
                else {
                  attributeValue = '';
                  if (attributeName in personData) {
                    personData[attributeName].push(attributeValue);
                  }
                  else if (booleanAttributes.includes(attributeName)){
                    personData[attributeName] = false;
                  }
                  else {
                    personData[attributeName] = [attributeValue];
                  }
                }
              }
            }
          }
        }
      }
    }

    return personData;
  }

  function buildQuestionnaireData() {
    const dataBuilder = [
      {
        tag: 'proband',
        count: 0,
        attributes: ['name', 'sex', 'dob',
          {
            masks: ['condition_code_%', 'condition_display_%', 'condition_other_%'],
            count: formCounts.conditions,
            attributes: ['condition_code', 'condition_display', 'condition_other']
          }
          ]
      },
      {
        tag: 'partner_%',
        count: formCounts.partner,
        attributes: ['name', 'dob', 'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'child_%',
        count: formCounts.child,
        attributes: ['name', 'sex', 'dob', 'parent_tag',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'sibling_%',
        count: formCounts.sibling,
        attributes: ['name', 'sex', 'dob', 'sibling_type',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'mother',
        count: 0,
        attributes: ['name', 'dob', 'maiden_name',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'father',
        count: 0,
        attributes: ['name', 'dob',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'm_sibling_%',
        count: formCounts.m_sibling,
        attributes: ['name', 'sex', 'dob', 'sibling_type',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'm_mother',
        count: 0,
        attributes: ['name', 'dob', 'maiden_name',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'm_father',
        count: 0,
        attributes: ['name', 'dob',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'm_extended_%',
        count: formCounts.m_extended,
        attributes: ['name', 'relationship', 'parent',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'f_sibling_%',
        count: formCounts.f_sibling,
        attributes: ['name', 'sex', 'dob', 'sibling_type',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'f_mother',
        count: 0,
        attributes: ['name', 'dob', 'maiden_name',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'f_father',
        count: 0,
        attributes: ['name', 'dob',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
      {
        tag: 'f_extended_%',
        count: formCounts.f_extended,
        attributes: ['name', 'relationship', 'parent',
          {masks: ['problem_%', 'problem_other_%', 'problem_age_%'], count: formCounts.conditions, attributes: ['problem', 'problem_other', 'problem_age']},
          'deceased', 'dod', 'cause_death']
      },
    ];

    let data = [];

    for (const personBuilder of dataBuilder) {
      if (personBuilder.count > 0) {
        for (let i = 1; i <= personBuilder.count; i++) {
          const personData = buildPersonData(personBuilder.tag.replace("%", i.toString()), personBuilder.attributes);
          if (personData) {
            data.push(personData);
          } else {
            break;
          }
        }
      } else {
        const personData = buildPersonData(personBuilder.tag, personBuilder.attributes);
        if (personData) {
          data.push(personData);
        }
      }
    }
    return data;
  }

  function forceUpdateQuestionnaireData(){
    let qData = JSON.parse(localStorage.getItem(qDataStorageKey));
    updateQuestionnaireData(qData);
  }

  function setupAutocomplete(){

    let fhir_server_uri = $('#ontologyServer').val();
    if (!fhir_server_uri) {
      fhir_server_uri = 'https://r4.ontoserver.csiro.au/fhir/';
    }
    const value_set_url = ($('#sctMode').is(':checked')) ?
              'http://snomed.info/sct?fhir_vs=refset/32570581000036105' :
              'http://www.omim.org';

    const processFunction = function( data, response ){
      result = [];
      if (data.expansion && data.expansion.contains){
        for (v of data.expansion.contains){
          result.push({ 'label' : v.display, 'value' : v.code});
        }
      }
      result.push({'label' : 'No Result Found', 'value': '_NRF_'})
      response( result );
    };

    const selectFunction = function(event, ui, id){
      event.preventDefault();
      // $(this).val(ui.item.label);
      $('#proband_condition_code_display_' + id).text(ui.item.value);
      $('#proband_condition_display_' + id).val(ui.item.label);
      $('#proband_condition_entry_' + id).val(ui.item.label);
      $('#proband_condition_code_' + id).val(ui.item.value);
      $('#proband_condition_other_' + id).val('');
      // delay change so draws properly
      window.setTimeout (() => {
        $('#proband_condition_display_' + id).change();
        $('#proband_condition_code_' + id).change();
        $('#proband_condition_other_' + id).change();
         }, 0);
      return true;
    };

    for (let i=1; i <= formCounts.conditions; i++){
      $('#proband_condition_entry_' + i).autocomplete({
        source: function( request, response ) {
          const type="GET";
          const processData = true;

          let url= fhir_server_uri + "/ValueSet/$expand";
          postData={ 'url': value_set_url, 'count':20, 'filter': request.term }


          $.ajax( {
            type: type,
            url: url,
            processData: processData,
            data: postData,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: (data) => processFunction(data, response)
          } );
        },
        select: (event, ui) => selectFunction(event, ui, i),
        minLength: 2
      });
    }

  }

  function changeCodeSystems(source){
    for (let i=1; i<=formCounts.conditions; i++){
      $('#proband_condition_display_' + i).val('').change();
      $('#proband_condition_code_' + i).val('').change();
      $('#proband_condition_code_display_' + i).text('');
      $('#proband_condition_other_' + i).val('').change();
      $('#proband_condition_entry_' + i).val('').change();
    }
    setupAutocomplete();
  }



  function updateQuestionnaireData(data){
    console.log('Nodes to process = ' + data.length);
    let hasChildren = false;
    let hasSiblings = false;
    let hasMSiblings = false;
    let hasFSiblings = false;
    for (let node of data){
      let tag = node.tag;
      console.log('process node with tag ' + tag);
      if (tag.startsWith('child') || tag.startsWith('partner')){
        hasChildren = true;
      } else if (tag.startsWith('sibling')){
        hasSiblings = true;
      } else if (tag.startsWith('m_sibling')){
        hasMSiblings = true;
      } else if (tag.startsWith('f_sibling')){
        hasFSiblings = true;
      }
      for (let attr in node){
        if (attr === 'tag'){
          continue;
        }
        let elementName = tag + '_' + attr;
        const element = $('#' + elementName);
        if (attr === 'deceased'){
          element.prop('checked', node[attr]).change();
        }
        else {
          element.val(node[attr]).change();
        }
      }
    }
    $('#have_children_flag').prop('checked', hasChildren).change();
    $('#have_siblings_flag').prop('checked', hasSiblings).change();
    $('#have_m_siblings_flag').prop('checked', hasMSiblings).change();
    $('#have_f_siblings_flag').prop('checked', hasFSiblings).change();
  }

  $(function() {

    let elementIteractions = [
      {testElement: 'have_children_flag', showElement: 'partners_section', count: 0, action: 'showIfSelected'},
      {testElement: 'have_children_flag', showElement: 'children_section', count: 0, action: 'showIfSelected'},
      {testElement: 'have_siblings_flag', showElement: 'siblings_section', count: 0, action: 'showIfSelected'},
      {testElement: 'have_m_siblings_flag', showElement: 'm_siblings_section', count: 0, action: 'showIfSelected'},
      {testElement: 'have_f_siblings_flag', showElement: 'f_siblings_section', count: 0, action: 'showIfSelected'},
    ];

    let generateProbandProblemEntries = function(section, elementIteractions){

      elementIteractions.push({testElement: 'proband_condition_display_%', showElement: 'proband_condition_row_%%', count: formCounts.conditions, action: 'showIfNotEmpty'});
      elementIteractions.push({testElement: 'proband_condition_code_%', showElement: 'proband_condition_other_row_%', count: formCounts.conditions, action: 'showIfEquals', actionValue:['_NRF_']});

      for (let i=1;i<=formCounts.conditions;i++) {
        $(section).append(`
    <div class="form-group" id="proband_condition_row_${i}">
      <div class="row">
        <div class="col-10">
          <label for="proband_condition_entry_1">Condition ${i}</label>
        </div>
      </div>
      <div class="row" id="proband_condition_display_row_${i}">
        <div class="col-10">
          <input type="text" class="form-control" id="proband_condition_entry_${i}" name="proband_condition_entry_${i}" aria-describedby="proband_condition_Help" placeholder="Enter condition (Hit Enter for new row)">
          <input type="hidden" id="proband_condition_display_${i}" name="proband_condition_display_${i}">
          <input type="hidden" id="proband_condition_code_${i}" name="proband_condition_code_${i}">
        </div>
        <div class="col-2">
          <small id="proband_condition_code_display_${i}" class="form-text text-muted"></small>
        </div>
      </div>
      <div class="row" id="proband_condition_other_row_${i}">
        <div class="col-12">
          <input type="text" class="form-control" id="proband_condition_other_${i}" name="proband_condition_other_${i}" aria-describedby="proband_condition_Help" placeholder="Enter condition">
          <div id="proband_condition_other_feedback_${i}" class="hidden invalid-feedback">Condition text should be provided for \`No Match Found\`</div>
        </div>
      </div>
    </div>
      `);
      }
    };

    let generateProblemEntries = function(tag, elementIteractions) {
      elementIteractions.push({testElement: tag + '_problem_%', showElement: tag + '_problem_row_%%', count: formCounts.conditions, action: 'showIfNotEmpty'});
      elementIteractions.push({testElement: tag + '_problem_%', showElement: tag + '_problem_other_%', count: formCounts.conditions, action: 'enableIfEquals', actionValue: ['other']});
      elementIteractions.push({testElement: tag + '_problem_%', showElement: tag + '_problem_age_%', count: formCounts.conditions, action: 'enableIfNotEmpty'});

      let entries = [];
      for (let i=1;i<=formCounts.conditions;i++){
        entries.push(`
          <div id="${tag}_problem_row_${i}" class="row">
            <div class="col-5 text-center">
              <select class="custom-select" id="${tag}_problem_${i}" name="${tag}_problem_${i}">
                <option value="" selected>No</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-5">
              <input type="text" class="form-control" id="${tag}_problem_other_${i}" name="${tag}_problem_other_${i}">
            </div>
            <div class="col-2">
              <input type="text" class="form-control" id="${tag}_problem_age_${i}" name="${tag}_problem_age_${i}">
            </div>
          </div>
        `);
      }
      return entries.join('\n');
    }

    let generateDeceasedEntry = function(tag) {
      return `
         <div class="row">
          <div class="col-2">Deceased</div>
          <div class="col-7">Cause of Death</div>
          <div class="col-2">Date of Death/Age</div>
        </div>
        <div class="row">
          <div class="col-2 text-center">
            <input class="form-check-input text-center" type="checkbox" name="${tag}_deceased" id="${tag}_deceased" value="deceased">
          </div>
          <div class="col-7">
            <input type="text" class="form-control" id="${tag}_cause_death" name="${tag}_cause_death">
          </div>
          <div class="col-2">
            <input type="text" class="form-control" id="${tag}_dod" name="${tag}_dod" placeholder="dd-mm-yyyy or '25y'">
          </div>
        </div>
      `;
    }

    let generateSiblingEntries = function(tag, count, name, section, elementIteractions) {

      elementIteractions.push({testElement: tag + '_%_deceased', showElement: tag + '_%_cause_death', count: count, action: 'enableIfSelected'});
      elementIteractions.push({testElement: tag + '_%_deceased', showElement: tag + '_%_dod', count: count, action: 'enableIfSelected'});
      elementIteractions.push({testElement: tag + '_%_name', showElement: tag + '_%%_section', count: count, action: 'showIfNotEmpty'});

      for (let i=1;i<=count;i++){
        const problemEntries = generateProblemEntries(tag + '_' + i, elementIteractions);
        const deceasedEntry = generateDeceasedEntry(tag + i);
        const siblingEntry = `
      <div id="${tag}_${i}_section">
        <div class="row">
          <div class="col-5">Full Name (${name} ${i})</div>
          <div class="col-2">Sex</div>
          <div class="col-3">Date of Birth/Age</div>
          <div class="col-2">Type</div>
        </div>
        <div class="row">
          <div class="col-5">
            <input type="text" class="form-control" id="${tag}_${i}_name" name="${tag}_${i}_name">
          </div>
          <div class="col-2">
            <select class="custom-select" id="${tag}_${i}_sex" name="${tag}_${i}_sex">
              <option value="" selected>Choose...</option>
              <option value="M">Male</option>
              <option value="F">Female</option>
              <option value="U">Other</option>
            </select>
          </div>
          <div class="col-3">
            <input type="text" class="form-control" id="${tag}_${i}_dob" name="${tag}_${i}_dob">
          </div>
          <div class="col-2">
            <select class="custom-select" id="${tag}_${i}_sibling_type" name="${tag}_${i}_sibling_type">
              <option value="" selected>Choose...</option>
              <option value="full">Full</option>
              <option value="mat">Maternal Half</option>
              <option value="pat">Paternal Half</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-5">Condition</div>
          <div class="col-2 offset-5">Age First Noticed</div>
        </div>
        ${problemEntries}
        ${deceasedEntry}
        <hr/>
      </div>`;
        $(section).append(siblingEntry);
      }
    };

    let generateMotherEntry = function(tag, name, section, elementIteractions) {
      elementIteractions.push({testElement: tag + '_deceased', showElement: tag + '_cause_death', count: 0, action: 'enableIfSelected'});
      elementIteractions.push({testElement: tag + '_deceased', showElement: tag + '_dod', count: 0, action: 'enableIfSelected'});

      const motherProblemEntries = generateProblemEntries(tag, elementIteractions);
      const motherDeceasedEntry = generateDeceasedEntry(tag);
      $(section).append(`
      <div class="row">
        <div class="col-5">Full Name (${name})</div>
        <div class="col-3">Date of Birth/Age</div>
        <div class="col-4">Maiden Name</div>
      </div>
      <div class="row">
        <div class="col-5">
          <input type="text" class="form-control" id="${tag}_name" name="${tag}_name">
        </div>
        <div class="col-3">
          <input type="text" class="form-control" id="${tag}_dob" name="${tag}_dob">
        </div>
        <div class="col-4">
          <input type="text" class="form-control" id="${tag}_maiden_name" name="${tag}_maiden_name">
        </div>
      </div>
      <div class="row">
        <div class="col-5">Condition</div>
        <div class="col-2 offset-5">Age First Noticed</div>
      </div>
      ${motherProblemEntries}
      ${motherDeceasedEntry}
    `);
    };

    let generateFatherEntry = function(tag, name, section, elementIteractions) {
      elementIteractions.push({testElement: tag + '_deceased', showElement: tag + '_cause_death', count: 0, action: 'enableIfSelected'});
      elementIteractions.push({testElement: tag + '_deceased', showElement: tag + '_dod', count: 0, action: 'enableIfSelected'});

      const fatherProblemEntries = generateProblemEntries(tag, elementIteractions);
      const fatherDeceasedEntry = generateDeceasedEntry(tag);
      $(section).append(`
    <div class="row">
      <div class="col-5">Full Name (${name})</div>
      <div class="col-3">Date of Birth/Age</div>
    </div>
    <div class="row">
      <div class="col-5">
        <input type="text" class="form-control" id="${tag}_name" name="${tag}_name">
      </div>
      <div class="col-3">
        <input type="text" class="form-control" id="${tag}_dob" name="${tag}_dob">
      </div>
    </div>
      <div class="row">
        <div class="col-5">Condition</div>
        <div class="col-2 offset-5">Age First Noticed</div>
      </div>
      ${fatherProblemEntries}
      ${fatherDeceasedEntry}
    `);
    };

    let generateExtendedEntries = function(tag, count, section, elementIteractions) {
      elementIteractions.push({testElement: tag + '_%_deceased', showElement: tag + '_%_cause_death', count: count, action: 'enableIfSelected'});
      elementIteractions.push({testElement: tag + '_%_deceased', showElement: tag + '_%_dod', count: count, action: 'enableIfSelected'});
      elementIteractions.push({testElement: tag + '_%_name', showElement: tag + '_%%_section', count: count, action: 'showIfNotEmpty'});

      for (let i = 1; i <= count; i++) {
        const problemEntries = generateProblemEntries(tag + '_' + i, elementIteractions);
        const deceasedEntry = generateDeceasedEntry(tag + i);

        $(section).append(`
      <div id="${tag}_${i}_section">
        <div class="row">
          <div class="col-3">Name</div>
          <div class="col-3">Relationship to you</div>
          <div class="col-3">Name of their parent and/or child</div>
          <div class="col-3">Date of Birth/Age</div>
        </div>
        <div class="row">
          <div class="col-3">
              <input type="text" class="form-control" id="${tag}_${i}_name" name="${tag}_${i}_name">
          </div>
          <div class="col-3">
            <select class="custom-select" id="${tag}_${i}_relationship" name="${tag}_${i}_relationship">
            <option value="" selected>Choose...</option>
            <option value="grandson">Grandson</option>
            <option value="granddaughter">Granddaughter</option>
            <option value="grandchild">Grandchild</option>
            <option value="great-grandson">Great-grandson</option>
            <option value="great-granddaughter">Great-granddaughter</option>
            <option value="great-grandchild">Great-grandchild</option>
            <option value="niece">Niece</option>
            <option value="nephew">Nephew</option>
            <option value="grandniece">Grandniece</option>
            <option value="grandnephew">Grandnephew</option>
            <option value="cousin">Cousin</option>
            <option value="great-grandmother">Great-grandmother</option>
            <option value="great-grandfather">Great-grandfather</option>
            <option value="granduncle">Granduncle</option>
            <option value="grandaunt">Grandaunt</option>
          </select>
          </div>
          <div class="col-3">
            <input type="text" class="form-control" id="${tag}_${i}_parent" name="${tag}_${i}_parent">
          </div>
          <div class="col-3">
            <input type="text" class="form-control" id="${tag}_${i}_problem" name="${tag}_${i}_dob">
          </div>
        </div>
      <div class="row">
        <div class="col-5">Condition</div>
        <div class="col-2 offset-5">Age First Noticed</div>
      </div>
        ${problemEntries}
        ${deceasedEntry}
        <hr/>
      </div>`);
      }
    };


    // generate the form

    generateProbandProblemEntries('#proband_conditions_section', elementIteractions);

    elementIteractions.push({testElement: 'partner_%_deceased', showElement: 'partner_%_cause_death', count: formCounts.partner, action: 'enableIfSelected'});
    elementIteractions.push({testElement: 'partner_%_deceased', showElement: 'partner_%_dod', count: formCounts.partner, action: 'enableIfSelected'});
    elementIteractions.push({testElement: 'partner_%_name', showElement: 'partner_%%_section', count: formCounts.partner, action: 'showIfNotEmpty'});

    for (let i=1;i<=formCounts.partner;i++){
      const deceasedEntry = generateDeceasedEntry('partner_' + i);
      $('#partners_section').append(
        `<div id="partner_${i}_section">
          <div class="row">
            <div class="col-7">Full Name (Partner ${i})</div>
            <div class="col-3">Date of Birth/Age</div>
          </div>
          <div class="row">
            <div class="col-7">
              <input type="text" class="form-control" id="partner_${i}_name" name="partner_${i}_name">
            </div>
            <div class="col-3">
              <input type="text" class="form-control" id="partner_${i}_dob" name="partner_${i}_dob" placeholder="dd-mm-yyyy or '25y'">
            </div>
          </div>
          ${deceasedEntry}
          <hr/>
        </div>`
      );
    }

    elementIteractions.push({testElement: 'child_%_deceased', showElement: 'child_%_cause_death', count: formCounts.child, action: 'enableIfSelected'});
    elementIteractions.push({testElement: 'child_%_deceased', showElement: 'child_%_dod', count: formCounts.child, action: 'enableIfSelected'});
    elementIteractions.push({testElement: 'child_%_name', showElement: 'child_%%_section', count: formCounts.child, action: 'showIfNotEmpty'});

    for (let i=1;i<=formCounts.child;i++){
      const problemEntries = generateProblemEntries('child_' + i, elementIteractions);
      const deceasedEntry = generateDeceasedEntry('child_' + i);
      $('#children_section').append(`
      <div id="child_${i}_section">
        <div class="row">
          <div class="col-5">Full Name (Child ${i})</div>
          <div class="col-2">Sex</div>
          <div class="col-3">Date of Birth/Age</div>
          <div class="col-2">Parent</div>
        </div>
        <div class="row">
          <div class="col-5">
            <input type="text" class="form-control" id="child_${i}_name" name="child_${i}_name">
          </div>
          <div class="col-2">
            <select class="custom-select" id="child_${i}_sex" name="child_${i}_sex">
              <option value="" selected>Choose...</option>
              <option value="M">Male</option>
              <option value="F">Female</option>
              <option value="U">Other</option>
            </select>
          </div>
          <div class="col-3">
            <input type="text" class="form-control" id="child_${i}_dob" name="child_${i}_dob" placeholder="dd-mm-yyyy or '25y'">
          </div>
          <div class="col-2">
            <select class="custom-select" id="child_${i}_parent_tag" name="child_${i}_parent_tag">
              <option value="partner_1" selected>Partner 1</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-5">Condition</div>
          <div class="col-2 offset-5">Age First Noticed</div>
        </div>
        ${problemEntries}
        ${deceasedEntry}
        <hr/>
      </div>`
      );
    }

    generateSiblingEntries('sibling', formCounts.sibling, 'Sibling', '#siblings_section', elementIteractions);
    generateMotherEntry('mother', 'Mother', '#mother_section', elementIteractions);
    generateFatherEntry('father', 'Father', '#father_section', elementIteractions);

    generateSiblingEntries('m_sibling', formCounts.m_sibling, 'Mothers\' Sibling', '#m_siblings_section', elementIteractions);
    generateMotherEntry('m_mother', 'Maternal Grandmother', '#m_mother_section', elementIteractions);
    generateFatherEntry('m_father', 'Maternal Grandfather', '#m_father_section', elementIteractions);
    generateExtendedEntries('m_extended', formCounts.m_extended, '#m_extended_section', elementIteractions);

    generateSiblingEntries('f_sibling', formCounts.m_sibling, 'Fathers\' Sibling', '#f_siblings_section', elementIteractions);
    generateMotherEntry('f_mother', 'Paternal Grandmother', '#f_mother_section', elementIteractions);
    generateFatherEntry('f_father', 'Paternal Grandfather', '#f_father_section', elementIteractions);
    generateExtendedEntries('f_extended', formCounts.f_extended, '#f_extended_section', elementIteractions);


    let checkNames = function(){
      let currentNames = new Set();
      let errorMessages = [];
      for (let tag of [ 'proband', 'partner', 'child', 'sibling', 'mother', 'father', 'm_sibling', 'm_mother',
        'm_father', 'm_extended', 'f_sibling', 'f_mother', 'f_father', 'f_extended']) {
        const count = formCounts.hasOwnProperty(tag) ? formCounts[tag] : 0;
        if (count === 0) {
          let elementId = tag + "_name";
          let element = $('#' + elementId);
          if (!element.length) {
            console.log('no element ' + elementId);
            continue;
          }
          let name = element.val().trim();
          if (name.length > 0) {
            currentNames.add(name);
          }
        } else {
          for (let j = 1; j <= count; j++) {
            let elementId = tag + '_' + j + "_name";
            let element = $('#' + elementId);
            if (!element.length) {
              break; // no more of this type.
            }
            let name = element.val().trim();
            if (name.length > 0) {
              currentNames.add(name);
            }
          }
        }
      }
      for (let i=1; i <= formCounts.m_extended; i++){
        let elementId = 'm_extended_' + (i).toString() + '_parent';
        let element = $('#' + elementId);
        if (!element.length) {
          break; // no more of this type.
        }
        let name = element.val().trim();
        let isOk = true;
        if (name.length > 0){
          console.log('Checking name ' + name);
          if (!currentNames.has(name)){
            isOk = false;
          }
        }
        if (isOk){
          element.removeClass('is-invalid');
        }
        else {
          element.addClass('is-invalid');
          errorMessages.push('Mothers extended family refers to unknown name \'' + name +'\'');
        }
      }
      for (let i=1; i <= formCounts.f_extended; i++){
        let elementId = 'f_extended_' + (i).toString() + '_parent';
        let element = $('#' + elementId);
        if (!element.length) {
          break; // no more of this type.
        }
        let name = element.val().trim();
        let isOk = true;
        if (name.length > 0){
          if (!currentNames.has(name)){
            isOk = false;
          }
        }
        if (isOk){
          element.removeClass('is-invalid');
        }
        else {
          element.addClass('is-invalid');
          errorMessages.push('Fathers extended family refers to unknown name \'' + name +'\'');
        }
      }
      $('#errmessage').val(errorMessages.join('\n'));
    };

    // deal with condition selection lists
    let populateConditionsSelectionLists = function(){
      let conditionOptions = [{value: '', display: 'No'}];

      for (let i=1; i<=formCounts.conditions; i++){
        const code = $('#proband_condition_code_' + i).val();
        const display = ('_NRF_' === code) ? $('#proband_condition_other_' + i).val() : $('#proband_condition_display_' + i).val();
        if (code && code.trim().length > 0){
          conditionOptions.push({value: 'condition_' + i, display: display.trim()});
        }
      }
      conditionOptions.push({value: 'other', display: 'Other'});

      let options = '';
      for (let option of conditionOptions){
        options += '<option value="' + option.value + '">'+option.display+'</option>'
      }

      for (let tag of ['child', 'sibling', 'mother', 'father',
        'm_mother', 'm_father','m_sibling', 'm_extended',
        'f_mother', 'f_father','f_sibling', 'f_extended']){
        const count = formCounts.hasOwnProperty(tag) ? formCounts[tag] : 0;
        if (count === 0){
          for (let j=1; j<=formCounts.conditions; j++){
            let selectElement = $('#' + tag + '_problem_' + j);
            if (selectElement.length){
              let value = selectElement.val();
              selectElement.empty().append(options).val(value);
            }
          }
        }
        else {
          for (let i=1; i<=count; i++){
            for (let j=1; j<=formCounts.conditions; j++){
              let selectElement = $('#' + tag + '_' + i + '_problem_' + j);
              if (selectElement.length){
                let value = selectElement.val();
                selectElement.empty().append(options).val(value);
              }
            }
         }
        }
      }

      return true;
    };

    let populatePartnerNameSelectionLists = function (event){
      let partnerOptions = [];
      for (let i=1; i<=4; i++){
        const name = $('#partner_' + i + '_name').val();
        if (name && name.trim().length > 0){
          partnerOptions.push({value: 'partner_' + i, display: name.trim()});
        }
      }
      let options = '';
      for (let option of partnerOptions){
        options += '<option value="' + option.value + '">'+option.display+'</option>'
      }

      // change sibling parent_tag drop downs
      for (let i=1; i<=formCounts.child; i++){
        let selectElement = $('#child_' + i + '_parent_tag');
        if (selectElement.length){
          let value = selectElement.val();
          if (!value && partnerOptions.length == 1){
            value = partnerOptions[0].value;
          }
          selectElement.empty().append(options).val(value);
        }
      }
    }

    let validateConditionOther = function(event, element, interaction){
      let id = element.attr('id');
      if (!id){
        console.log('Failed to find id of element');
        return true;
      }
      let indexChar = id[id.length - 1];
      if (indexChar < '1' || indexChar > '9'){
        console.log('Element id doesn\'t end with digit - ' + id );
        return true;
      }
      let index = parseInt(indexChar);
      let isOK = true;
      let otherElement = $('#proband_condition_other_' + index);
      let code = $('#proband_condition_code_' + index).val();
      if (code === '_NRF_'){
        let other = otherElement.val();
        if (other === ''){
          isOK = false;
        }
      }
      $('#proband_condition_other_feedback_' + index).toggle(!isOK);
      if (isOK){
        otherElement.removeClass('is-invalid');
      } else {
        otherElement.addClass('is-invalid');
      }
      return true;
    }


    // add validation checks
    for (let tag of ['proband', 'partner', 'child', 'sibling', 'mother', 'father',
      'm_mother', 'm_father','m_sibling', 'm_extended',
      'f_mother', 'f_father','f_sibling', 'f_extended']){
      const count = formCounts.hasOwnProperty(tag) ? formCounts[tag] : 0;
      const name = tag + (count?'_%':'') + '_name';
      elementIteractions.push({testElement: name, showElement: null, count: count, action: 'run', actionValue: checkNames});
    }

    elementIteractions.push({testElement: 'm_extended_%_parent', showElement: null, count: formCounts.m_extended, action: 'run', actionValue: checkNames});
    elementIteractions.push({testElement: 'f_extended_%_parent', showElement: null, count: formCounts.f_extended, action: 'run', actionValue: checkNames});
    elementIteractions.push({testElement: 'proband_condition_code_%', showElement: null, count: formCounts.conditions, action: 'run', actionValue: populateConditionsSelectionLists});
    elementIteractions.push({testElement: 'proband_condition_other_%', showElement: null, count: formCounts.conditions, action: 'run', actionValue: populateConditionsSelectionLists});
    elementIteractions.push({testElement: 'proband_condition_other_%', showElement: null, count: formCounts.conditions, action: 'run', actionValue: validateConditionOther});
    elementIteractions.push({testElement: 'partner_%_name', showElement: null, count: formCounts.partner, action: 'run', actionValue: populatePartnerNameSelectionLists});


    let interactionToAdd;
    const interactionsByTestElement = {};
    for (const ei of elementIteractions){
      if (ei.count){
        for (let i=1; i <= ei.count; i++){
          const testSelector = ei.testElement.replace('%%', (i+1).toString()).replace('%', i.toString());
          const showSelector = ei.showElement === null ? null : ei.showElement.replace('%%', (i+1).toString()).replace('%', i.toString());
          const testElement = $('#' + testSelector);
          const showElement = showSelector === null ? null : $('#' + showSelector);
          if (testElement.length && (showElement == null || showElement.length)){
            interactionToAdd = {element: showElement, action: ei.action, actionValue: ei.actionValue};
            if (testSelector in interactionsByTestElement){
              interactionsByTestElement[testSelector].push(interactionToAdd);
            }
            else {
              interactionsByTestElement[testSelector] = [interactionToAdd];
            }
          }
        }
      }
      else {
        const testElement = $('#' + ei.testElement);
        const showElement = ei.showElement === null ? null : $('#' + ei.showElement);
        if (testElement.length && (showElement == null || showElement.length)){
          interactionToAdd = { element: showElement, action: ei.action, actionValue: ei.actionValue};
          if (ei.testElement in interactionsByTestElement){
            interactionsByTestElement[ei.testElement].push(interactionToAdd);
          }
          else {
            interactionsByTestElement[ei.testElement] = [interactionToAdd];
          }
        }
      }
    }
    for (const testElement in interactionsByTestElement){
      $('#' + testElement).change(interactionsByTestElement[testElement], function(event){
        for (const interaction of event.data){
          switch (interaction.action){
            case 'showIfSelected':
              checked = $(this).prop('checked');
              interaction.element.toggle(checked);
              break;
            case 'enableIfSelected':
              checked = $(this).prop('checked');
              interaction.element.prop('disabled', !checked);
              break;
          case 'showIfNotEmpty':
            val = $(this).val();
            show = val !== '';
            interaction.element.toggle(show);
            break;
          case 'enableIfEquals':
            val = $(this).val();
            enable = interaction.actionValue.includes(val);
            interaction.element.prop('disabled', !enable);
            break;
          case 'showIfEquals':
            val = $(this).val();
            show = interaction.actionValue.includes(val);
            interaction.element.toggle(show);
            break;
          case 'enableIfNotEmpty':
            val = $(this).val();
            enable = val !== ''
            interaction.element.prop('disabled', !enable);
            break;
          case 'run':
            interaction.actionValue(event, $(this), interaction);
          }
        }
      }).change();
    }

    setupAutocomplete();
  });
  // ]]>
</script>




<div class="container-fluid">
  <h1>Medical & Family History Questionnaire and Patient Information Sheet</h1>
  <form>
    <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseEditorOptions" aria-expanded="false" aria-controls="collapseEditorOptions">
      Editor Options
    </button>
    <div class="collapse" id="collapseEditorOptions">
      <div class="card card-body">
        <div class="form-group">
          <label for="context">Editor Context</label>
          <input type="text" class="form-control" id="context" aria-describedby="contextHelp" placeholder="Enter context">
          <small id="contextHelp" class="form-text text-muted">The context is sent to panogram and then returned with saved diagram data.</small>
        </div>
        <div class="form-group">
          <label for="ontologyServer">Ontology Server</label>
          <input type="text" class="form-control" id="ontologyServer" aria-describedby="contextHelp" value="https://r4.ontoserver.csiro.au/fhir/" placeholder="Enter Server of leave blank for default">
          <small id="ontologyHelp" class="form-text text-muted">The ontology server used to lookup disorders and phenotypes</small>
        </div>
        <div class="form-group">
          <label>Mode</label>
          <div class="form-control">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="mode" id="hpoMode" value="HPO" onchange="changeCodeSystems(this)">
              <label class="form-check-label" for="hpoMode">HPO</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="mode" id="sctMode" value="SCT" checked="checked" onchange="changeCodeSystems(this)">
              <label class="form-check-label active" for="sctMode">SCT</label>
            </div>
          </div>
          <small class="form-text text-muted">Code system to use for disorders and phenotypes. Warning changing will
          remove any entered patient conditions.</small>
        </div>
      </div>
    </div>

    <div>
      <h2>Your medical history</h2>
      Please provide details of medical and surgical issues relating to you.
    </div>
    <hr>
    <div class="row">
      <div class="col-5">Full Name</div>
      <div class="col-2">Sex</div>
      <div class="col-3">Date of Birth</div>
    </div>
    <div class="row">
      <div class="col-5">
        <input type="text" class="form-control" id="proband_name" name="proband_name">
      </div>
      <div class="col-2">
        <select class="custom-select" id="proband_sex" name="proband_sex">
          <option value="" selected>Choose...</option>
          <option value="M">Male</option>
          <option value="F">Female</option>
          <option value="U">Other</option>
        </select>
      </div>
      <div class="col-3">
        <input type="text" class="form-control" id="proband_dob" name="proband_dob">
      </div>
    </div>
    <hr>
    <h3>Patient Conditions</h3>
    <div id="proband_conditions_section">
      <div class="row">
        <div class="col-10">
          <label></label>
        </div>
      </div>
    </div>
    <hr>
    <h2>Family history information</h2>
    <div class="form-group-inline">
      <label for="have_children_flag">Do you have children?</label>
      <select class="custom-select" id="have_children_flag" name="have_children_flag">
        <option value="" selected>No</option>
        <option value="Yes" >Yes</option>
      </select>
    </div>
    <div id="partners_section">
      <h3>Partners</h3>
      Please provide details of partners whom you have children with.
      <hr/>
    </div>

    <div id="children_section">
      <h3>Children</h3>
      <hr/>
    </div>

    <hr/>
    <div class="form-group-inline">
      <label for="have_siblings_flag">Do you have brothers and sisters?</label>
      <select class="custom-select" id="have_siblings_flag" name="have_siblings_flag">
        <option value="" selected>No</option>
        <option value="Yes" >Yes</option>
      </select>
    </div>
    <div id="siblings_section">
      Please list all your brothers and sisters, living and deceased.  If sisters have married please list the surnames
      they use now.  For each sibling, please select whether they are full siblings (have the same mother and father as
      yourself); maternal half-siblings (have the same mother as you but different father); paternal half-sibling (have
      the same father as you but different mother). If you have step brothers/sisters that are not related by blood,
      please do not list them.

      <h3>Brothers and Sisters</h3>
      <hr/>
    </div>
    <hr/>
    <h3>Mother</h3>
    <hr/>
    <div id="mother_section">
    </div>
    <hr/>

    <h3>Father</h3>
    <hr/>
    <div id="father_section">
    </div>
    <hr/>

    <h2>Mothers Family</h2>
    <hr/>
    Your mother’s brothers and sisters (your uncles and aunts)
    <div class="form-group-inline">
      <label for="have_siblings_flag">Does your mother have any brothers and sisters?</label>
      <select class="custom-select" id="have_m_siblings_flag" name="have_m_siblings_flag">
        <option value="" selected>No</option>
        <option value="Yes" >Yes</option>
      </select>
    </div>
    <hr/>
    <div id="m_siblings_section">
      Please list all your mother’s brothers and sisters, living and deceased. If women have married, please list the
      surnames they use now.  For each of your mother’s siblings, please select whether they are full siblings (have
      the same mother and father as your mother); maternal half-siblings (have the same mother as your mother but
      different father); paternal half-sibling (have the same father as your mother but different mother).
      If your mother has step brothers/sisters that are not related by blood, please do not list them.

      <h3>Mothers Siblings</h3>
      <hr/>
    </div>

    <hr/>
    <h3>Mothers Mother (Maternal Grandmother)</h3>
    <hr/>
    <div id="m_mother_section">
    </div>
    <hr/>
    <h3>Mothers Father (Maternal Grandfather)</h3>
    <hr/>
    <div id="m_father_section">
    </div>
    <hr/>
    <h3>Your mother’s extended family</h3>
    Please give details of any cousins or other relatives on your mother’s side of the family who have had health problems

    <hr/>
    <div id="m_extended_section">
    </div>
    <hr/>

    <h2>Fathers Family</h2>
    <hr/>
    Your father’s brothers and sisters (your uncles and aunts)
    <div class="form-group-inline">
      <label for="have_siblings_flag">Does your father have any brothers and sisters?</label>
      <select class="custom-select" id="have_f_siblings_flag" name="have_f_siblings_flag">
        <option value="" selected>No</option>
        <option value="Yes" >Yes</option>
      </select>
    </div>
    <hr/>
    <div id="f_siblings_section">
      Please list all your father’s brothers and sisters, living and deceased. If women have married, please list the
      surnames they use now.  For each of your father’s siblings, please select whether they are full siblings (have
      the same mother and father as your mother); maternal half-siblings (have the same mother as your mother but
      different father); paternal half-sibling (have the same father as your mother but different mother).
      If your father has step brothers/sisters that are not related by blood, please do not list them.
      <h3>Fathers Siblings</h3>
      <hr/>
    </div>

    <hr/>
    <h3>Fathers Mother (Paternal Grandmother)</h3>
    <hr/>
    <div id="f_mother_section">
    </div>
    <hr/>
    <h3>Fathers Father (Paternal Grandfather)</h3>
    <hr/>
    <div id="f_father_section">
    </div>
    <hr/>
    <h3>Your father’s extended family</h3>
    Please give details of any cousins or other relatives on your fathers’s side of the family who have had health problems

    <hr/>
    <div id="f_extended_section">
    </div>
    <hr/>
    <hr/>

    <div class="form-group">
      <label for="data">Data</label>
      <textarea class="form-control" id="data" rows="10" readonly>
      </textarea>
    </div>
    <hr/>
    <div class="form-group">
      <label for="errmessage">Error Message</label>
      <textarea class="form-control" id="errmessage" rows="10" readonly>
      </textarea>
    </div>
    <hr/>
    <button type="button" id="editButton" class="btn btn-primary" onclick="openEditor(this)">Edit</button>
    <button type="button" id="clearButton" class="btn btn-primary" onclick="clearData(this)">Clear</button>
    <button type="button" id="errorButton" class="btn btn-primary" onclick="generateError(this)">Error</button>

  </form>
  <div class="row" id="SVGContainer">

  </div>
</div>
</body>
</html>

